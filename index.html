<!DOCTYPE html>
<html>
<head>
  <title>Outvoice</title>
  <meta charset="utf-8">
  <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA////AN3V1QDo4+MA/4CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADMiIiIiMwADNERERERDMAMkIiIiIkIwAyQyMjIyQjADJBMTExNCMAMkMTExMUIwAyQRERERQjADJBMTExNCMAMkEREREUIwAyQxMTIyQjADJBERRERDMAMkERFBFCMwAyQREUFCMzADJBERRCMzMAM0RERCMzMwADMiIjMzMwDAAwAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAADAAwAA" rel="icon" type="image/x-icon" />
<style type="text/css">
* { user-select: none }
html {
  padding: 0 8px;
  background-color: hsl(240, 10%, 90%);
}

body {
  width: 672px;
  width: 84ch;
  margin: 0 auto;
  color: hsl(240, 30%, 50%);
}

body, textarea, input, pre, a {
  font-family:
    'SF Mono',
    Monaco,
    Inconsolata,
    'Fira Mono',
    'Droid Sans Mono',
    'Source Code Pro',
    monospace;
}

h1, h2, h3 {
  font-family:
    system-ui,
    -apple-system,
    BlinkMacSystemFont,
    'Segoe UI',
    Roboto,
    Helvetica,
    Arial,
    sans-serif,
    'Apple Color Emoji',
    'Segoe UI Emoji',
    'Segoe UI Symbol';
}

h1 {
  font-size: 70px;
  text-align: center;
  color: hsl(240, 100%, 75%);
  margin: 10px 0 0;
  font-style: italic;
  letter-spacing: -2px;
}

h1 span {
  color: hsl(240, 10%, 80%);
  font-weight: 100;
  letter-spacing: 0;
}

h2 { position: relative }
h2:after {
  content:'';    
  width: calc(100% - 24px);
  height: 16px;
  z-index: -1;
  background-color: hsl(240, 10%, 85%);
  position: absolute;
  top: 55%;
  left: 12px;
}

h3 {
  font-size: 16px;
  font-variant: small-caps;
  letter-spacing: 2px;
  margin-bottom: 4px;
}

b { color: black }
a { color: hsl(240, 70%, 50%); text-decoration: none }
a:hover, a:focus { text-decoration: underline }
li:before { content: '> ' }
ul { list-style-type: none; padding-left: 1em }
hr { height: 0; border: none }

/* inputs */
label { margin-right: 16px }

input[type="number"] {
  width: 6ch;
}

input {
  color: black;
  background-color: hsl(240, 100%, 97%);
}

input, button {
  padding: 6px 8px;
  font-size: 16px;
  border: 3px solid hsl(240, 10%, 85%);
  border-radius: 5px;
}

button {
  color: black;
  border-color: hsl(240, 10%, 85%);
  background-color: hsl(240, 10%, 85%);
  font-weight: bold;
  letter-spacing: 1px;
  line-height: 17px;
}

textarea, pre {
  font-size: 16px;
  width: 80ch;
  top: 0;
  color: black;
  cursor: text;
  padding: 2ch;
  border-width: 0px;
  overflow: hidden;
}

textarea {
  opacity: 0;
  height: calc(100% - 4ch);
  background-color: white;
  position: absolute;
  resize: none;
  box-shadow:
     10px 7px 20px 12px rgba(0, 0, 0, 0.04),
    -10px 7px 20px 12px rgba(0, 0, 0, 0.04),
      0px 4px 13px  4px rgba(0, 0, 0, 0.20);
}

pre {
  background-color: rgba(255, 255, 255, 0.75);
  box-shadow:
     5px 5px 10px 6px rgba(0, 0, 0, 0.03),
    -5px 5px 10px 6px rgba(0, 0, 0, 0.03),
     0px 2px  6px 3px rgba(0, 0, 0, 0.10);
}

/* elements */
#invoice-wrapper { position: relative }
#content { opacity: 0; transition: opacity 0.5s ease }

/* interactions */
input:hover, button:hover { border-color: black }
textarea:hover, textarea:focus, textarea:active { opacity: 1 }
input:focus { background-color: hsl(240, 100%, 99%) }
button:focus { color: hsl(240, 100%, 75%) }
button:focus, input:focus {
  border-color: hsl(240, 100%, 75%);
  outline: none;
}

input:active, button:active { border-color: hsl(240, 100%, 50%) }
button:active { color: hsl(240, 100%, 50%) }

/* hide shortcuts */
.hide-shortcuts b { color: inherit; font-weight: inherit }

/* display mode */
.display-mode, .display-mode * { box-shadow: none!important; background: white }
.display-mode * { display: none }
.display-mode pre, body, #content, #invoice-wrapper { display: block!important }

/* print mode */
@media print {
  * { display: none }
  * { box-shadow: none!important; background: white }
  pre, html, body, #content, #invoice-wrapper { display: block!important }
}

/* cross browser support */
@supports (-moz-appearance:none) { textarea { top: -1px } }
</style>
</head>




<body>
  <h1>Outvoice<span>.github.io</span></h1>
  <div id="content">
    <div style="display: flex;">

      <div>
        <h2>Inputs</h2>
        <h3>Items</h3>
        <label>
          <span><b>d</b>escription</span>
          <input id="description" type="text" style="width: 38ch" maxlength="37">
        </label>
        <hr>
        <label>
          <span><b>p</b>rice</span>
          <input id="price" type="number" min="0" max="9999999">
        </label>
        <label>
          <span><b>q</b>ty</span>
          <input id="qty" type="number" min="0" max="9999">
        </label>
        <label style="margin-right: 0">
          <span><b>v</b>at</span>
          <input id="vat" type="number" min="0" max="99">
        </label>
        <button id="add">&nbsp+&nbsp</button>

        <h3>D<b>a</b>te</h3>
        <label>
          <input id="date" type="date">
        </label>
        <label>
          <span>due <b>i</b>n</span>
          <input id="due" type="number" min="0" max="999">
          days
        </label>
      </div>

      <div style="flex-grow: 1">
        <h2>Outputs</h2>
        <ul>
          <li><a id="link-text" download="file.txt">te<b>x</b>t</a></li>
          <li><a id="link-pdf" download="file.pdf">pd<b>f</b></a></li>
          <li><a id="link-link" href="#"><b>l</b>ink</a></li>
          <li><a id="link-link-edit" href="#">lin<b>k</b></a> <i>editable</i></li>
          <li><a id="link-email" href="mailto:">e<b>m</b>ail</a></li>
          <li><a id="link-print" href="#">p<b>r</b>int</a></li>
          <li><a id="link-copy" href="#"><b>c</b>opy</a></li>
        </ul>
      </div>

    </div>

    <h2 style="margin: 42px 0">I<b>n</b>voice</h2>
    <div id="invoice-wrapper">
      <textarea tabindex="1" id="invoice-text"></textarea>
      <pre id="invoice"></pre>
    </div>
  </div>




<script type="text/javascript">
// UTILS
const getById = id => document.getElementById(id)
const makeFile = (text, ext, type) => {
  const file = new File([text], `outvoice.${ext}`, { type })
  return URL.createObjectURL(file)
}

const replacer = (rgx, map) => (fn => s => s.replace(rgx, fn))(c => map[c])
const urlSafeEncode = replacer(/[+/=]/g, { '+': '-', '/': '_', '=': '.' })
const urlSafeDecode = replacer(/[-_.]/g, { '-': '+', '_': '/', '.': '=' })
const pdfEscape = replacer(/[()\\]/g, { '(': '\\(', '\\': '\\\\', ')': '\\)' })
const encodeData = d => urlSafeEncode(btoa(JSON.stringify(d)))
const decodeData = d => JSON.parse(atob(urlSafeDecode(d)))
const toPDF = text => `%PDF-1.5
1 0 obj <</Type /Catalog /Pages 2 0 R>> endobj
2 0 obj <</Type /Pages /Kids [3 0 R] /Count 1>> endobj
3 0 obj <</Type /Page /Parent 2 0 R /Resources 4 0 R /MediaBox [0 0 595 842] /Contents 6 0 R>> endobj
4 0 obj <</Font <</F1 5 0 R>>>> endobj
5 0 obj <</Type /Font /Subtype /Type1 /BaseFont /Courier New, Courier>> endobj
6 0 obj <</Length 7680>> stream
  BT
  /F1 11 Tf
  26 795 Td
  18 TL
  ${text.split('\n')
  .map((line, index) => `(${pdfEscape(line)}) ${index ? "'" : 'Tj'}`)
  .join('\n  ')}
  ET
endstream endobj

xref
0 7
0000000000 65535 f
0000000009 00000 n
0000000059 00000 n
0000000116 00000 n
0000000219 00000 n
0000000259 00000 n
0000000328 00000 n

trailer <</Size 7/Root 1 0 R>>

startxref
454
%%EOF`




// INDEX DB
const idb = (() => {
const dbp = new Promise((resolve, reject) => {
  const openreq = window.indexedDB.open('use-idb', 1)
    openreq.onerror = () => reject(openreq.error)
    openreq.onsuccess = () => resolve(openreq.result)
    openreq.onupgradeneeded = () => openreq.result.createObjectStore('idb')
  })

  const call = async (type, method, ...args) => {
    const db = await dbp
    const transaction = db.transaction('idb', type)
    const store = transaction.objectStore('idb')

    return new Promise((resolve, reject) => {
      const req = store[method](...args)
      transaction.oncomplete = () => resolve(req)
      transaction.onabort = transaction.onerror = () => reject(transaction.error)
    })
  }

  return {
    get: async key => (await call('readonly', 'get', key)).result,
    set: (key, value) => value === undefined
      ? call('readwrite', 'delete', key)
      : call('readwrite', 'put', value, key)
  }
})()




// STATE MANAGEMENT
const handlers = {
  get: elem => elem.value,
  set: (elem, value) => elem.value = value,
  parse: _ => _,
  compare: (a, b) => a === b,
  compareRaw: (a, b) => a === b,
  persist: true,
  INPUTnumber: {
    get: elem => elem.valueAsNumber,
    set: (elem, value) => elem.valueAsNumber = Number(value),
  },
  INPUTdate: {
    compare: (a, b) => a && b && a.getTime() === b.getTime(),
    compareRaw: (a, b) => a && b && a.getTime() === b.getTime(),
    get: elem => elem.valueAsDate,
    set: (elem, value) => elem.valueAsDate = new Date(value),
  },
}

const events = new Set
const loop = () => {
  for (const ev of events) ev()
  setTimeout(() => requestAnimationFrame(loop))
}

const exec = (subs, value) => {
  try { for (const sub of subs) sub(value) }
  catch (err) { console.error('Unhandled:', err.stack) }
}

const __ = _ => _
const stated = (id, defaultValue, opts) => {
  const elem = getById(id)
  const { get, set, persist, parse, compare, compareRaw } = {
    ...handlers,
    ...handlers[elem.tagName+elem.type],
    ...opts,
  }

  const subs = new Set
  const subsError = new Set
  let _value
  let _failed
  let _nextValue
  let _rawValue
  let _wasFocus

  const apply = value => compare(value, _value) ? value : (_nextValue = value)

  events.add(() => {
    const isFocus = document.activeElement === elem
    if (isFocus) {
      const newRawValue = get(elem)
      if (newRawValue === null) return
      if (!compareRaw(_rawValue, newRawValue)) {
        try {
          apply(parse(newRawValue, _value))
          _failed = false
          _rawValue = newRawValue
        } catch (err) {
          console.log('failed to parse new input value for state', id)
          console.log(newRawValue)
          console.warn(err.stack)
          _failed = true
          set(elem, _value)
          setTimeout(exec, 0, subsError, err)
          return
        }
      }
    } else if (_wasFocus) {
      _wasFocus = false
      set(elem, _value)
      setTimeout(exec, 0, subs, _value)
      return
    }

    if (_failed) return
    if (_nextValue === undefined) return

    _value = _nextValue
    _nextValue = undefined
    setTimeout(exec, 0, subs, _value)
    isFocus ? (_wasFocus = true) : set(elem, _value)
    persist && idb.set(id, _value).catch(console.error)
  })

  const init = persist
    ? idb.get(id).then(value => apply(value || defaultValue))
    : Promise.resolve().then(() => apply(defaultValue))

  return {
    elem,
    then: init.then.bind(init),
    catch: init.catch.bind(init),
    set: value => apply(value),
    getRaw: () => _rawValue,
    get: () => _value,
    once: (fn, s) => s = subs.delete(v => s(fn(v))),
    sub: (success, failure) => {
      typeof success === 'function' && subs.add(success)
      typeof failure === 'function' && subsError.add(failure)
      return () => {
        subs.delete(success)
        subsError.delete(failure)
      }
    }
  }
}

const hyperLink = (id, generate) => {
  const a = getById(id)
  let _update

  const apply = e => {
    _update && (a.href = generate())
    _update = undefined
  }

  a.addEventListener('mouseenter', apply, { passive: true })

  a.open = mod => {
    apply()
    a.dispatchEvent(new MouseEvent('click', { ctrlKey: mod, metaKey: mod }))
  }

  return () => _update = true
}



// PARSING & FORMATING
const PADS = {
  description: 37,
  subtotal: 9,
  total: 22,
  price: 8,
  qty: 4,
  vat: 4,
  no: 3,
}

const padAll = obj => Object.keys(obj)
  .map(key => Number(obj[key]) == obj[key]
    ? String(obj[key]).padStart(PADS[key] || 0, ' ')
    : ` ${String(obj[key]).padEnd(PADS[key] - 1 || 0, ' ')}`)

const getTotalExcl = items => `(excl tax) ${Math.ceil(items
    .reduce((acc, { price, qty }) => price * qty + acc, 0))}`
  .padStart(PADS.total, ' ')

const getTotalVat = items => `+ ${items
    .reduce((acc, { price, qty, vat }) => price*(vat/100) * qty + acc, 0)
    .toFixed(2)}`
  .padStart(PADS.total, ' ')

const getTotalIncl = items => `(incl tax): ${items
    .reduce((acc, { price, qty, vat }) => (price + price*(vat/100))*qty + acc, 0)
    .toFixed(2)} EURO`
  .padEnd(36, ' ')

const getList = items => items
  .map(({ description, price = 0, qty = 1, vat = 0 }, i) => padAll({
    no: String(i + 1).padStart(2, '0'),
    description,
    price: `${price}`,
    qty,
    vat,
    subtotal: `${price * qty}`,
  })
  .join(' |'))
  .map(l => `  |${l} |`)
  .join('\n')

const formatInvoiceFixed = ({ header, separator, body, items, due, date }) => [
  header,
  formatDate(date),
  separator,
  formatDate(date, due),
  body, `
        -----------------------------------------------------------------------
       | DESCRIPTION                          |  PRICE  | QTY | VAT | SUBTOTAL |
   ............................................................................|
${getList(items)}
   -------------------------------------------|................................|
                                              |         ${getTotalExcl(items)} |
> TOTAL ${getTotalIncl(items)              }  |         ${ getTotalVat(items)} |
                                               --------------------------------
` ].join('')

const normalizeSpaces = str => str.replace(/ +/g, ' ')
const formatInvoiceFluid =  ({ header, separator, body, items, due, date }) => [
  normalizeSpaces(header),
  formatDate(date),
  normalizeSpaces(separator),
  formatDate(date, due),
  normalizeSpaces(body), `> ITEMS
${items.map(({ description, price = 0, qty = 1, vat = 0 }) => [
  description,
  ' - ',
  `${price} EURO`,
  vat && ` (${vat}% VAT)`,
  qty > 2 && ` x${qty}`,
].filter(Boolean).join('')).join('\n')}

> TOTAL
${getTotalExcl(items).trim()} ${getTotalVat(items).trim()} (VAT)
${getTotalIncl(items).trim().replace(':', '')}` ].join('')

const trim = s => s.trim()
const pad2 = n => String(n).padStart(2, '0')
const getId = date => {
  const m = pad2(date.getMonth() + 1)
  const y = date.getFullYear()
  return [ m, y, String((localStorage[m+y] || 1)).padStart(3, '0') ].join('-')
}

const formatDate = (d, offset = 0) => {
  const e = new Date(d.getFullYear(), d.getMonth(), d.getDate() + offset)
  return [ e.getDate(), e.getMonth()+1, e.getFullYear() ].map(pad2).join('/')
}

const parseItemLine = line => {
  const matches = line.split('|').map(trim).filter(Boolean)
  const description = matches[1]
  const price = Number(matches[2])
  const qty = Number(matches[3])
  const vat = Number(matches[4])
  return { description, price, qty, vat }
}

const parseInvoiceText = (value, prev) => {
  const [ , header, separator, body, items ] = value
    .split(/([^]*?)\d+\/\d+\/\d+([^]*?)\d+\/\d+\/\d+([^]*?)\n.+\n.+\| DESCRIPTION.+ \|\n.+([^]*?)\n   -/)

  return {
    ...prev,
    header,
    separator,
    body,
    items: items.trim().split('\n').filter(trim).map(parseItemLine),
  }
}




// HANDLE DISPLAY MODE
let urlData = {}
try {
  const params = new URLSearchParams(window.location.search)
  if (params.get('data')) {
    urlData = decodeData(params.get('data'))
    urlData.date = new Date(urlData.date)
    const editable = params.has('edit')
    urlData.persistance = { override: editable, persist: editable }
    editable || document.documentElement.classList.add('display-mode')
  }
} catch (err) {
  console.log('Error loading url', window.location.search)
  console.log(err)
}




// ELEMENTS
const persistance = urlData.persistance || { persist: true }
const defaultDate = urlData.date || new Date
const invoicePre = getById('invoice')
const addButton = getById('add')
const descriptionState = stated('description', urlData.description || 'Software Development')
const priceState = stated('price', urlData.price || 400)
const qtyState = stated('qty', urlData.qty || 1)
const vatState = stated('vat', urlData.vat || '0')
const dueState = stated('due', urlData.due || 7, persistance)
const dateState = stated('date', defaultDate, { persist: false })
const invoiceState = stated('invoice-text', {
  header: `# Invoice ${getId(defaultDate)}\n\nCreated `,
  date: defaultDate,
  separator: ` - Due `,
  due: urlData.due || 7,
  body: `

> FROM
  NAME     Clark Kent
  ADDRESS  66 rue Wonder Woman - 99000 Metropolis - FRANCE
  EMAIL    email@gmail.com
  PHONE    +33601020304
  SIRET    88776655400000
  IBAN     FR76167980000000000000000000
  BIC      TRZOFR21XXX

> BILLED TO
  NAME     SUPERMAN INC
  ADDRESS  66 rue Wonder Woman - 99000 Metropolis - FRANCE
  EMAIL    superman@dc.comics
  VAT      101010101

`,
  items: [
    { description: 'Software Development', price: 400, qty: 1, vat: 0 },
    { description: 'Some License', price: 27, qty: 3, vat: 20 },
  ],
  ...urlData,
}, {
  ...persistance,
  parse: parseInvoiceText,
  set: (elem, invoice) => elem.value = formatInvoiceFixed(invoice),
})




// HANDLE EVENTS
const states = [
  descriptionState,
  priceState,
  qtyState,
  vatState,
  dateState,
  dueState,
  invoiceState,
]

const textarea = invoiceState.elem

const selections = [ ...states.slice(0, 4), addButton, ...states.slice(4) ]
  .map(elem => elem.elem || elem)

const inputs = selections.filter(elem => elem !== addButton)

const isFocused = elem => document.activeElement === elem
const baseUrl = `${window.location.origin}${window.location.pathname}`

const copy = () => navigator.clipboard.writeText(textarea.value)
const addItem = () => invoiceState.set({
  ...invoiceState.get(),
  items: [
    ...invoiceState.get().items,
    {
      description: descriptionState.get(),
      price: priceState.get(),
      qty: qtyState.get(),
      vat: vatState.get(),
    },
  ],
})

invoiceState.sub(hyperLink('link-text', () =>
  makeFile(textarea.value, 'txt', 'plain/text')))

invoiceState.sub(hyperLink('link-pdf', () =>
  makeFile(toPDF(textarea.value),  'pdf', 'application/pdf')))
 
invoiceState.sub(hyperLink('link-link', () =>
  `${baseUrl}?data=${encodeData(invoiceState.get())}`))

const regenEditLink = hyperLink('link-link-edit', () =>
  `${baseUrl}?edit&data=${encodeData({
    description: descriptionState.get(),
    price: priceState.get(),
    qty: qtyState.get(),
    vat: vatState.get(),
    ...invoiceState.get(),
  })}`)

invoiceState.sub(regenEditLink)
qtyState.sub(regenEditLink)
vatState.sub(regenEditLink)
priceState.sub(regenEditLink)
descriptionState.sub(regenEditLink)

invoiceState.sub(hyperLink('link-email', () => {
  const textFuild = formatInvoiceFluid(invoiceState.get())
  const emails = textFuild.split(/(\S+@\S+\.\S+)/g).filter((_, i) => i % 2)
  const subject = textFuild.trim().split('\n').filter(Boolean)[0]

  return `mailto:${emails[emails.length-1]
    }?subject=${encodeURIComponent(subject)
    }&body=${encodeURIComponent(textFuild)}`
}))

getById('link-print').addEventListener('click', e => window.print())
getById('link-copy').addEventListener('click', copy)

invoiceState.sub(() => invoicePre.textContent = textarea.value)
dueState.sub(due => invoiceState.set({ ...invoiceState.get(), due }))
dateState.sub(date => invoiceState.set({ ...invoiceState.get(), date }))
addButton.addEventListener('click', addItem)

events.add(() => {
  const hide = !document.hasFocus() || inputs.some(isFocused)
  document.body.classList.toggle('hide-shortcuts', hide)
})

Promise.all(states)
  .then(loop)
  .then(() => getById('content').style.opacity = 1)

const eventOpen = a => e => a.open(e.shiftKey)
const eventSelect = input => e => {
  input.focus()
  e.shiftKey && input.select()
}

const selectors = {
  enter: () => {
    document.activeElement === addButton && addItem()
    inputs[0].focus()
  },
  d: eventSelect(descriptionState.elem),
  p: eventSelect(priceState.elem),
  q: eventSelect(qtyState.elem),
  v: eventSelect(vatState.elem),
  a: eventSelect(dateState.elem),
  i: eventSelect(dueState.elem),
  n: eventSelect(textarea),
  '+': addItem,
  '=': addItem,
  x: eventOpen(getById('link-text')),
  f: eventOpen(getById('link-pdf')),
  m: eventOpen(getById('link-email')),
  l: eventOpen(getById('link-link')),
  k: eventOpen(getById('link-link-edit')),
  r: eventOpen(getById('link-print')),
  c: copy,
}

addEventListener('keydown', e => {
  const k = e.key.toLowerCase()
  const isAction = e.ctrlKey || e.metaKey
  if (!inputs.some(isFocused)) {
    if (isAction) {
      if (k === 's') {
        e.preventDefault()
        selectors.x() // save text file
      } else if (k === 'a') {
        if (!e.metaKey && !e.ctrlKey) return
        e.preventDefault()
        textarea.select()
      }
      return
    }
    selectors[k] && selectors[k](e) !== false && e.preventDefault()
    return
  }

  switch (k) {
    case 'enter':
      if (document.activeElement === textarea) {
        return requestAnimationFrame(() => invoiceState.elem.scrollTop = 0)
      }
      e.preventDefault()
      const index = selections.indexOf(document.activeElement)
        + (e.shiftKey ? -1 : 1)

      const clampedIndex = index < 0
        ? selections.length - 1
        : index % selections.length

      return selections[clampedIndex].focus()
    case 'escape':
      return document.activeElement.blur && document.activeElement.blur()
  }
})




/* * * * TODO * * *
 * sublime like ctrl+x / ctrl+v with no selection
 * handle override
 * mousewheel over inputs
 * save / list / restore previous 
 * autocompletion for used items
 * - max width
 * - max height
 * - proper table markers
 * - show error to users
 * - ascii only ?
 check si link cree des leaks
 user help
 legacy version
 */

</script>
</body>
</html>
